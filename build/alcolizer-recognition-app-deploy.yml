AWSTemplateFormatVersion: 2010-09-09
Description: >-
  The is to deply the lambda function used but the alcolizer-rekognition step function
  to parse and process the Alcolizer email.
Parameters:
  HierarchyKey:
    Type: String
    Default: dev
    Description: This is the environment that will determine the SSMParamaters - dev/test/production
    MinLength: '1'
    ConstraintDescription: This parameter is required.    
  AlcolizerBucket:
    Type: String
    Default: dev-alcolizer-rekognition 
    Description: The name of the S3 bucket to store the Alcolizer files.
    MinLength: '1'
    ConstraintDescription: This parameter is required.    
Resources:
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: 'Alcolizer-Rekognition Notifcation Topic'
      TopicName: !Join ['', ['alcolizer-rekognition-notification', '-', !Ref 'HierarchyKey']] 
  EmailNotificationSubscription:
    Type: 'AWS::SNS::Subscription'
    Properties:
      TopicArn: !Ref NotificationTopic
      Endpoint: !GetAtt 
        - AlcolizerEmailNotificationFunctionHndlr
        - Arn
      Protocol: lambda
  SNSNotificationSubscription:
    Type: 'AWS::SNS::Subscription'
    Properties:
      TopicArn: !Ref NotificationTopic
      Endpoint: !GetAtt 
        - AlcolizerSMSNotificationFunctionHndlr
        - Arn
      Protocol: lambda      
  AlcolizerEmailNotificationFunctionHndlr:
    Type: AWS::Lambda::Function
    Properties:      
      FunctionName : !Join ['', ['alcolizer-send-positive-email', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-send-positive-email.lambda_handler
      Role: !GetAtt
        - LambdaS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-send-positive-email.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300  
  EmailNotificationFunctionInvokePermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref AlcolizerEmailNotificationFunctionHndlr
      Principal: sns.amazonaws.com   
  AlcolizerSMSNotificationFunctionHndlr:
    Type: AWS::Lambda::Function
    Properties:      
      FunctionName : !Join ['', ['alcolizer-send-positive-sms', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-send-positive-sms.lambda_handler
      Role: !GetAtt
        - LambdaS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-send-positive-sms.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300  
  SMSNotificationFunctionInvokePermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref AlcolizerSMSNotificationFunctionHndlr
      Principal: sns.amazonaws.com  
  AlcolizerStartStepFunctionHndlr:
    Type: AWS::Lambda::Function
    Properties:      
      FunctionName : !Join ['', ['alcolizer-start-stepfunction', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-start-stepfunction.lambda_handler
      Role: !GetAtt
        - BasicRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-start-stepfunction.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300  
  AlcolizerClassifyEmailHndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-classify-email', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-classify-email.lambda_handler
      Role: !GetAtt
        - LambdaS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket
        S3Key: code/handlers/alcolizer-classify-email.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300
  AlcolizerIgnoreEmailHndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-ignore-email', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-ignore-email.lambda_handler
      Role: !GetAtt
        - BasicRole
        - Arn
      Code:
          S3Bucket: !Ref AlcolizerBucket 
          S3Key: code/handlers/alcolizer-ignore-email.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300
  AlcolizerParseStoreEmailHndlr:
    Type: AWS::Lambda::Function
    Description: This is the function that parses and stores the email int the database and the images on s3.
    Properties:
      FunctionName: !Join ['', ['alcolizer-parse-store-email', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-parse-store-email.lambda_handler
      Role: !GetAtt
        - LambdaS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-parse-store-email.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300
  AlcolizerMatchFaceHndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-match-face', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-match-face.lambda_handler
      Role: !GetAtt
        - LambdaAcceS3AccessRekognitionAccessRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-match-face.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300
  AlcolizerWeightRekognitionHndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-weight-rekognition', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-weight-rekognition.lambda_handler
      Role: !GetAtt
        - BasicRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-weight-rekognition.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300
  AlcolizerStoreOutputToS3Hndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-store-output-s3', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-store-output-s3.lambda_handler
      Role: !GetAtt
        - LambdaS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-store-output-s3.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300
  AlcolizerStoreStatusToS3Hndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-store-status-log', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-store-status-log.lambda_handler
      Role: !GetAtt
        - LambdaS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-store-status-log.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300
  AlcolizerSendStatusNotificationHndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-send-status-notification', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-send-status-notification.lambda_handler
      Role: !GetAtt
        - LambdaS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-send-status-notification.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300      
  AlcolizerSendPositiveNotificationHndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-send-positive-notification', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-send-positive-notification.lambda_handler
      Role: !GetAtt
        - LambdaVPCConnectedS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-send-positive-notification.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300     
  AlcolizerExtractEmailAttachmentHndlr:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Join ['', ['alcolizer-extract-email-attachment', '-', !Ref 'HierarchyKey']]
      Handler: alcolizer-extract-email-attachment.lambda_handler
      Role: !GetAtt
        - LambdaS3AccessLambdaPutRole
        - Arn
      Code:
        S3Bucket: !Ref AlcolizerBucket 
        S3Key: code/handlers/alcolizer-extract-email-attachment.zip
      Runtime: python3.8
      Environment:
        Variables:
          hierarchy: !Ref 'HierarchyKey'
      Timeout: 300
  AlcolizerRekognizerEmailStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: !Join ['', ['Alcolizer-Rekognizer-Email-Statemachine', '-', !Ref 'HierarchyKey']]
      RoleArn: !GetAtt
        - AlcolizerStepFunctionRole
        - Arn
      DefinitionS3Location:
        Bucket: !Ref AlcolizerBucket 
        Key: code/state-machine/rekognise-alcolizer-email-state-machine.json
      DefinitionSubstitutions:      
        AlcolizerClassifyEmailArn: !GetAtt 
          - AlcolizerClassifyEmailHndlr
          - Arn
        AlcolizerIgnoreEmailArn: !GetAtt 
          - AlcolizerIgnoreEmailHndlr 
          - Arn
        AlcolizerParseStoreEmailArn: !GetAtt 
          - AlcolizerParseStoreEmailHndlr
          - Arn
        AlcolizerMatchFaceArn: !GetAtt 
          - AlcolizerMatchFaceHndlr 
          - Arn 
        AlcolizerWeightRekognitionArn: !GetAtt 
          - AlcolizerWeightRekognitionHndlr
          - Arn    
        AlcolizerStoreOutputToS3Arn: !GetAtt 
          - AlcolizerStoreOutputToS3Hndlr
          - Arn         
        AlcolizerStoreStatusToS3Arn: !GetAtt 
          - AlcolizerStoreStatusToS3Hndlr
          - Arn     
        AlcolizerSendStatusNotificationArn: !GetAtt 
          - AlcolizerSendStatusNotificationHndlr
          - Arn       
        AlcolizerSendPositiveNotificationArn: !GetAtt 
          - AlcolizerSendPositiveNotificationHndlr
          - Arn       
        AlcolizerExtractEmailAttachmentArn: !GetAtt
          - AlcolizerExtractEmailAttachmentHndlr
          - Arn  
  BasicRole:
    Type: 'AWS::IAM::Role'    
    Properties:
      RoleName: !Join ['', ['alcolizer-rekognition-lambda-execution-role', '-', !Ref 'HierarchyKey']] 
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
          - PolicyName: AlcolizerAccessParameter
            PolicyDocument:
              Version: 2012-10-17                           
              Statement:
                - Effect: Allow
                  Action: 
                    - 'states:StartExecution'
                  Resource: '*'
                - Effect: Allow
                  Action: 
                    - 'ssm:GetParameter'
                    - 'ssm:GetParameters'
                    - 'ssm:GetParametersByPath'
                  Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/alcolizer-rekognition/*                                
  LambdaS3AccessLambdaPutRole:
      Type: 'AWS::IAM::Role'    
      Properties:
        RoleName: !Join ['', ['alcolizer-rekognition-lambda-parse-email-role', '-', !Ref 'HierarchyKey']] 
        AssumeRolePolicyDocument:
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - 'sts:AssumeRole'
        ManagedPolicyArns:
          - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
          - 'arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess'
          - 'arn:aws:iam::aws:policy/AmazonSNSFullAccess'
          - 'arn:aws:iam::aws:policy/AmazonSESFullAccess'
        Policies:
          - PolicyName: AlcolizerAccessS3BucketA
            PolicyDocument:
              Version: 2012-10-17
              Statement:
                - Effect: Allow
                  Action: 
                      - 's3:GetObject'
                      - 's3:PutObject'
                      - 's3:PutObjectAcl'
                  Resource: !Join ['', ['arn:aws:s3:::', !Ref 'AlcolizerBucket', '/*']]                     
                - Effect: Allow
                  Action: 
                    - 'ssm:GetParameter'
                    - 'ssm:GetParameters'
                    - 'ssm:GetParametersByPath'
                  Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/alcolizer-rekognition/*                                   
  LambdaVPCConnectedS3AccessLambdaPutRole:
      Type: 'AWS::IAM::Role'    
      Properties:
        RoleName: !Join ['', ['alcolizer-rekognition-lambda-VPC-connected-role', '-', !Ref 'HierarchyKey']] 
        AssumeRolePolicyDocument:
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - 'sts:AssumeRole'
        ManagedPolicyArns:
          - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
          - 'arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess'
          - 'arn:aws:iam::aws:policy/AmazonSNSFullAccess'
          - 'arn:aws:iam::aws:policy/AmazonSESFullAccess'
        Policies:
          - PolicyName: AlcolizerAccessS3BucketA
            PolicyDocument:
              Version: 2012-10-17
              Statement:
                - Effect: Allow
                  Action: 
                      - 's3:GetObject'
                      - 's3:PutObject'
                      - 's3:PutObjectAcl'
                  Resource: !Join ['', ['arn:aws:s3:::', !Ref 'AlcolizerBucket', '/*']]                     
                - Effect: Allow
                  Action: 
                    - 'ssm:GetParameter'
                    - 'ssm:GetParameters'
                    - 'ssm:GetParametersByPath'
                  Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/alcolizer-rekognition/*          
                - Effect: Allow
                  Action: 
                    - 'ec2:DescribeNetworkInterfaces'
                    - 'ec2:CreateNetworkInterface'
                    - 'ec2:DeleteNetworkInterface'
                    - 'ec2:DescribeInstances'
                    - 'ec2:AttachNetworkInterface'
                    - 'ec2:DetachNetworkInterface'                    
                  Resource: '*'            
  S3ReadRole:
      Type: 'AWS::IAM::Role'    
      Properties:
        RoleName: !Join ['', ['alcolizer-rekognition-read-s3-role', '-', !Ref 'HierarchyKey']] 
        AssumeRolePolicyDocument:
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - 'sts:AssumeRole'
        ManagedPolicyArns:
          - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
        Policies:
          - PolicyName: AlcolizerAccessS3BucketB
            PolicyDocument:
              Version: 2012-10-17
              Statement:
                - Effect: Allow
                  Action: 
                      - 's3:GetObject'
                  Resource: !Join ['', ['arn:aws:s3:::', !Ref 'AlcolizerBucket', '/*']]                
                - Effect: Allow
                  Action: 
                    - 'ssm:GetParameter'
                    - 'ssm:GetParameters'
                    - 'ssm:GetParametersByPath'
                  Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/alcolizer-rekognition/*     
  LambdaAcceS3AccessRekognitionAccessRole:
      Type: 'AWS::IAM::Role'    
      Properties:
        RoleName: !Join ['', ['alcolizer-rekognition-match-faces-role', '-', !Ref 'HierarchyKey']] 
        AssumeRolePolicyDocument:
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - 'sts:AssumeRole'
        ManagedPolicyArns:
          - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
          - 'arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess'          
          - 'arn:aws:iam::aws:policy/AmazonRekognitionFullAccess'
        Policies:
          - PolicyName: AlcolizerAccessS3BucketC
            PolicyDocument:
              Version: 2012-10-17
              Statement:
                - Effect: Allow
                  Action: 
                    - 's3:GetObject'
                  Resource: !Join ['', ['arn:aws:s3:::', !Ref 'AlcolizerBucket', '/*']]                
                - Effect: Allow
                  Action: 
                    - 'ssm:GetParameter'
                    - 'ssm:GetParameters'
                    - 'ssm:GetParametersByPath'
                  Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/alcolizer-rekognition/*       
  AlcolizerStepFunctionRole:
    Type: 'AWS::IAM::Role'    
    Properties:
      RoleName: !Join ['', ['alcolizer-rekognition-step-function-role', '-', !Ref 'HierarchyKey']] 
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - !Sub states.${AWS::Region}.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Policies:
        - PolicyName: AlcolizerAccessS3BucketC
          PolicyDocument:
            Version: 2012-10-17            
            Statement:
              - Effect: Allow
                Action: 
                  - 'lambda:InvokeFunction'
                Resource: 
                  - !GetAtt 
                    - AlcolizerClassifyEmailHndlr
                    - Arn
                  - !GetAtt 
                    - AlcolizerIgnoreEmailHndlr
                    - Arn
                  - !GetAtt 
                    - AlcolizerParseStoreEmailHndlr
                    - Arn
                  - !GetAtt 
                    - AlcolizerMatchFaceHndlr 
                    - Arn 
                  - !GetAtt 
                    - AlcolizerWeightRekognitionHndlr
                    - Arn       
                  - !GetAtt 
                    - AlcolizerStoreOutputToS3Hndlr
                    - Arn    
                  - !GetAtt 
                    - AlcolizerStoreStatusToS3Hndlr
                    - Arn    
                  - !GetAtt 
                    - AlcolizerSendStatusNotificationHndlr
                    - Arn  
                  - !GetAtt 
                    - AlcolizerSendPositiveNotificationHndlr
                    - Arn  
                  - !GetAtt 
                    - AlcolizerExtractEmailAttachmentHndlr
                    - Arn        
              - Effect: Allow
                Action: 
                  - 'xray:PutTraceSegments'
                  - 'xray:PutTelemetryRecords'
                  - 'ray:GetSamplingRules'
                  - 'xray:GetSamplingTargets'
                Resource: '*'            
              - Effect: Allow
                Action: 
                  - 'ssm:GetParameter'
                  - 'ssm:GetParameters'
                  - 'ssm:GetParametersByPath'
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/alcolizer-rekognition/*            