AWSTemplateFormatVersion: "2010-09-09"
Description: >-
  The is to deploy the two dynamodb tables used by the Alcolizer-rekcognition app.    
Parameters:
  HierarchyKey:
    Type: String
    Default: ianb
    Description: This is the environment that will determine the SSMParamaters - dev/test/production
    MinLength: '1'
    ConstraintDescription: This parameter is required.  
  MinCapacityUnits:
    Type: Number
    Default: 5
    Description: This is the minimum read and write capacity units
    ConstraintDescription: This parameter is required.    
Resources: 
  AlcolizerResults: 
    Type: AWS::DynamoDB::Table
    Properties: 
      TableName: !Join ['', ['alcolizer-', !Ref HierarchyKey, '-breathalyzer-results']] 
      BillingMode: 'PROVISIONED'
      KeySchema: 
          - AttributeName: 'eventId'
            KeyType: 'HASH'
          - AttributeName: 'utcdatetime'
            KeyType: 'RANGE'
      ProvisionedThroughput: 
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5      
      AttributeDefinitions: 
        - AttributeName: 'eventId'
          AttributeType: 'S'
        - AttributeName: 'utcdatetime'
          AttributeType: 'S'
  RekognitionResults: 
    Type: AWS::DynamoDB::Table
    Properties: 
      TableName: !Join ['', ['alcolizer-', !Ref HierarchyKey, '-rekognition-results']]
      KeySchema: 
          - AttributeName: 'rowUid'
            KeyType: "HASH"
      ProvisionedThroughput: 
          ReadCapacityUnits: !Ref MinCapacityUnits
          WriteCapacityUnits: !Ref MinCapacityUnits
      AttributeDefinitions: 
        - AttributeName: 'rowUid'
          AttributeType: 'S'
  AlcolizerConfig: 
    Type: AWS::DynamoDB::Table
    Properties: 
      TableName: !Join ['', ['alcolizer-', !Ref HierarchyKey, '-alcolizer-location-map']]
      BillingMode: 'PROVISIONED'
      KeySchema: 
          - AttributeName: 'serialNo'
            KeyType: 'HASH'
      ProvisionedThroughput: 
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5      
      AttributeDefinitions: 
        - AttributeName: 'serialNo'
          AttributeType: 'N'
  ScalingRole: 
    Type: AWS::IAM::Role
    Properties: 
      RoleName: !Join ['', ['ScalingRole-', !Ref HierarchyKey ]]
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - Effect: Allow
            Principal: 
              Service: 
                - application-autoscaling.amazonaws.com
            Action: 
              - sts:AssumeRole
  ScalingRolePolicy:
    Type: AWS::IAM::Policy
    Properties:
        Roles:
        - !Ref ScalingRole
        PolicyName: !Join ['', ['ScalingRolePolicyPolicy-', !Ref HierarchyKey ]]
        PolicyDocument: 
          Version: '2012-10-17'
          Statement: 
          - Effect: Allow
            Action:
              - application-autoscaling:*
              - dynamodb:DescribeTable
              - dynamodb:UpdateTable
              - cloudwatch:PutMetricAlarm
              - cloudwatch:DescribeAlarms
              - cloudwatch:GetMetricStatistics
              - cloudwatch:SetAlarmState
              - cloudwatch:DeleteAlarms
            Resource: '*'
  TableWriteCapacityScalableTargetBreathalyzer:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties: 
        MaxCapacity: !Ref MinCapacityUnits
        MinCapacity: !Ref MinCapacityUnits
        ResourceId: !Join ['', ['table/alcolizer-', !Ref HierarchyKey, '-breathalyzer-results']]
        RoleARN: !GetAtt 
          - ScalingRole
          - Arn
        ScalableDimension: dynamodb:table:WriteCapacityUnits
        ServiceNamespace: dynamodb
  TableWriteCapacityScalableTargetAlcolyzer:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties: 
        MaxCapacity: !Ref MinCapacityUnits
        MinCapacity: !Ref MinCapacityUnits
        ResourceId: !Join ['', ['table/alcolizer-', !Ref HierarchyKey, '-rekognition-results']]
        RoleARN: !GetAtt 
          - ScalingRole
          - Arn
        ScalableDimension: dynamodb:table:WriteCapacityUnits
        ServiceNamespace: dynamodb
  TableWriteCapacityScalableTargetConfig:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties: 
        MaxCapacity: !Ref MinCapacityUnits
        MinCapacity: !Ref MinCapacityUnits
        ResourceId: !Join ['', ['table/alcolizer-', !Ref HierarchyKey, '-alcolizer-location-map']] 
        RoleARN: !GetAtt 
          - ScalingRole
          - Arn
        ScalableDimension: dynamodb:table:WriteCapacityUnits
        ServiceNamespace: dynamodb
  TableWriteScalingPolicyBreathalyzer:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
        PolicyName: !Join ['', ['TableWriteScalingPolicyBreathalyzer-', !Ref HierarchyKey ]] 
        PolicyType: TargetTrackingScaling
        ScalingTargetId: !Ref TableWriteCapacityScalableTargetBreathalyzer
        TargetTrackingScalingPolicyConfiguration: 
            TargetValue: 70
            ScaleInCooldown: 60
            ScaleOutCooldown: 60
            PredefinedMetricSpecification: 
                PredefinedMetricType: DynamoDBWriteCapacityUtilization
  TableWriteScalingPolicyAlcolizer:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
        PolicyName: !Join ['', ['TableWriteScalingPolicyAlcolizer-', !Ref HierarchyKey ]] 
        PolicyType: TargetTrackingScaling
        ScalingTargetId: !Ref TableWriteCapacityScalableTargetAlcolyzer
        TargetTrackingScalingPolicyConfiguration: 
            TargetValue: 70
            ScaleInCooldown: 60
            ScaleOutCooldown: 60
            PredefinedMetricSpecification: 
                PredefinedMetricType: DynamoDBWriteCapacityUtilization
  TableWriteScalingPolicyAlcolizer:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
        PolicyName: !Join ['', ['TableWriteScalingPolicyConfig-', !Ref HierarchyKey ]] 
        PolicyType: TargetTrackingScaling
        ScalingTargetId: !Ref TableWriteCapacityScalableTargetConfig
        TargetTrackingScalingPolicyConfiguration: 
            TargetValue: 70
            ScaleInCooldown: 60
            ScaleOutCooldown: 60
            PredefinedMetricSpecification: 
                PredefinedMetricType: DynamoDBWriteCapacityUtilization